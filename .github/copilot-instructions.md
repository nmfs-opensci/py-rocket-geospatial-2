# Copilot Instructions for py-rocket-geospatial-2

## Project Purpose

This repository builds a Docker image (`py-rocket-geospatial-2`) that provides a comprehensive Python and R geospatial computing environment. The image includes:

- **Python 3.11** with geospatial packages (Pangeo notebook environment + CryoCloud-like extensions)
- **R 4.5.X** with Rocker geospatial packages
- **Desktop environment** with QGIS, CoastWatch Utilities, and Panoply
- **Documentation tools**: TeXLive, Quarto, MyST, JupyterBook
- **Base infrastructure**: Jupyter, Dask, RStudio from [py-rocket-base](https://github.com/nmfs-opensci/py-rocket-base/)

The image is published to `ghcr.io/nmfs-opensci/container-images/py-rocket-geospatial-2` and is intended for NMFS OpenSci JupyterHubs and local development.

## Repository Structure

### Core Files that Define the Image

- **`Dockerfile`**: Main build definition, layers on top of py-rocket-base
- **`environment/env-*.yml`**: Five separate conda environment files installed sequentially to avoid solver issues:
  - `env-core1.yml` - Core scientific packages (first batch)
  - `env-core2.yml` - Core scientific packages (second batch)
  - `env-geo.yml` - Geospatial packages
  - `env-viz.yml` - Visualization packages
  - `env-qgis.yml` - QGIS-related packages
- **`install.R`**: R package installations (in addition to tidyverse and geospatial from rocker scripts)
- **`apt.txt`**: System-level package installations

### Auto-Generated Package Pins

- **`packages-python-pinned.yaml`**: Auto-generated list of Python packages from env-*.yml files with exact versions
- **`packages-r-pinned.R`**: Auto-generated list of all R packages from site-library with exact versions
- **`build.log`**: Validation report showing whether all specified packages are present in the built image

### GitHub Actions

- **`.github/workflows/build-and-push.yml`**: Builds and pushes Docker image on changes to core files
- **`.github/workflows/pin-packages.yml`**: Runs after successful builds to extract and validate package versions
- **`.github/scripts/`**: Python and R scripts for package validation and extraction

## Development Conventions

### Adding Python Packages

1. **Add packages to the appropriate env-*.yml file**:
   - Place core scientific packages in `env-core1.yml` or `env-core2.yml`
   - Place geospatial packages in `env-geo.yml`
   - Place visualization packages in `env-viz.yml`
   - Place QGIS-related packages in `env-qgis.yml`

2. **Why multiple files?**: The conda solver was timing out with a single large environment file. Sequential installation of smaller files resolves this.

3. **Format**: Use standard conda environment YAML format with package names (versions are auto-extracted post-build)

### Adding R Packages

1. **Edit `install.R`**: Add package names to the appropriate section
2. **Note**: Core R ecosystem (tidyverse, geospatial) is installed via rocker scripts from the base image
3. **Format**: Standard R install.packages() calls with CRAN binary repo specified

### Adding System Packages

1. **Edit `apt.txt`**: Add one package name per line
2. These are installed via apt-get during the Docker build

### Package Management Rules

- **Never remove or edit** `packages-python-pinned.yaml` or `packages-r-pinned.R` manually - they are auto-generated
- **Never remove or edit** `build.log` - it is auto-generated by CI
- The pin-packages workflow validates that all packages from env files and rocker scripts are present in the container
- If validation fails, investigate the build logs to understand why packages failed to install

### Build and Testing

- **Manual trigger**: Use GitHub Actions "Docker Image Build and Push" workflow
- **Automatic trigger**: Push to main branch with changes to Dockerfile, env files, install.R, or apt.txt
- **Build time**: Expect 30-60+ minutes for full build
- **Post-build**: Pin-packages workflow automatically runs and creates a PR with updated pins

### Docker Image Versioning

- Images are tagged with dates (e.g., `2026.02.08`)
- Latest tag always points to the most recent successful build
- Version in Dockerfile LABEL should be updated when making releases

## Code Quality Standards

### When Modifying Environment Files

- Maintain consistent YAML formatting (2-space indentation)
- Add comments explaining why specific packages are included if not obvious
- Group related packages together

### When Modifying install.R

- Preserve the guardrail check that prevents installation to /home
- Maintain comments that document package purposes
- Keep the structure organized by functional categories

### When Modifying Dockerfile

- Preserve the multi-stage permission handling (root â†’ NB_USER)
- Keep the sequential conda environment installation order
- Maintain all LABEL fields for container metadata
- Document any new RUN commands with inline comments

## Important Constraints

1. **Do NOT modify** files in `.github/agents/` - these are for other specialized agents
2. **Do NOT break** the sequential conda environment installation - the order matters for solver success
3. **Do NOT install R packages to /home** - they must go to site-library (guardrails exist in install.R)
4. **Do NOT remove** existing packages without understanding dependencies - this is a shared base image
5. **Core functionality changes**: If changes affect base infrastructure (Jupyter, Dask, user experience), file an issue in [py-rocket-base](https://github.com/nmfs-opensci/py-rocket-base/issues) instead

## Derivative Images

Users can create derivative images using this as a base. When helping with derivative images:

- Point them to the example in README.md
- Remind them to use the pyrocket_scripts for package installation
- Ensure they understand that derivative images layer on top of the conda and R environments

## Testing and Validation

- There are no traditional unit tests for this repository
- Validation happens via the pin-packages workflow after image builds
- Manual testing involves pulling and running the Docker image locally
- Check that the conda notebook environment activates correctly
- Verify R can be used from both RStudio and JupyterLab
- Ensure Desktop applications (QGIS, Panoply, CoastWatch Utilities) launch properly

## Common Issues

1. **Conda solver hangs**: This is why we split into multiple env files - do not consolidate them back
2. **R packages missing**: Ensure install_geospatial.sh runs before other R installs (see Dockerfile order)
3. **Build validation fails**: Check build.log in the auto-generated PR for details on missing packages
4. **Permission errors**: Ensure proper USER context in Dockerfile (root for installs, NB_USER for final)

## Additional Context

- This repository moved from [nmfs-opensci/container-images](https://github.com/nmfs-opensci/container-images) to a dedicated repo in February 2026
- The Python environment is based on Pangeo/CryoCloud patterns for cloud-native geospatial analysis
- The R environment follows Rocker project conventions
- Documentation for the base image: https://nmfs-opensci.github.io/py-rocket-base/
