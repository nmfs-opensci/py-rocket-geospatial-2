name: Docker Image Build and Push

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests and push image directly (for debugging image build issues)'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main
    paths:
      - '.github/actions/build-and-push/action.yml'
      - '.github/workflows/build-and-push.yml'
      - 'Dockerfile'
      - 'conda-env/env-*.yml'
      - 'install.R'
      - 'apt.txt'
      - 'Desktop/**'

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.setup.outputs.tag }}
      image_name: ${{ steps.setup.outputs.full_name }}
      skip_tests: ${{ steps.check_skip.outputs.skip_tests }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if tests should be skipped
        id: check_skip
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.skip_tests }}" = "true" ]; then
            echo "skip_tests=true" >> $GITHUB_OUTPUT
          else
            echo "skip_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Image Name
        id: setup
        run: |
          echo "name=container-images/py-rocket-geospatial-2" >> $GITHUB_ENV
          echo "full_name=ghcr.io/${{ github.repository_owner }}/container-images/py-rocket-geospatial-2" >> $GITHUB_OUTPUT
          
          # Extract VERSION from Dockerfile
          if grep -q "LABEL org.opencontainers.image.version=" Dockerfile; then
            version=$(grep "LABEL org.opencontainers.image.version=" Dockerfile | cut -d '=' -f 2 | tr -d ' ')
          elif grep -q "LABEL VERSION=" Dockerfile; then
            version=$(grep "LABEL VERSION=" Dockerfile | cut -d '=' -f 2 | tr -d ' ')
          else
            version=""
          fi
          echo "version=${version}" >> $GITHUB_ENV
          
          # Create a short SHA for tagging
          short_sha=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "tag=${short_sha}" >> $GITHUB_ENV
          echo "tag=${short_sha}" >> $GITHUB_OUTPUT

      - name: Build the Docker image
        run: |
          # Build the Docker image with both tags
          docker build . \
            -f Dockerfile \
            --build-arg GITHUB_PAT=${{ secrets.GITHUB_TOKEN }} \
            --tag ghcr.io/${{ github.repository_owner }}/${{ env.name }}:${{ env.tag }} \
            --tag ghcr.io/${{ github.repository_owner }}/${{ env.name }}:latest
          
          # If VERSION exists, tag the image with that as well
          if [ -n "${{ env.version }}" ]; then
            docker tag ghcr.io/${{ github.repository_owner }}/${{ env.name }}:${{ env.tag }} ghcr.io/${{ github.repository_owner }}/${{ env.name }}:${{ env.version }}
          fi

      - name: Save Docker image as artifact
        run: |
          docker save ghcr.io/${{ github.repository_owner }}/${{ env.name }}:${{ env.tag }} | gzip > /tmp/docker-image.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/docker-image.tar.gz
          retention-days: 1

  test-python:
    runs-on: ubuntu-latest
    needs: build
    # Only run if tests are not skipped
    if: ${{ needs.build.outputs.skip_tests == 'false' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: |
          docker load < /tmp/docker-image.tar.gz

      - name: Configure NASA Earthdata Login
        continue-on-error: true
        env:
          EARTHDATA_USER: ${{ secrets.EARTHDATA_USER}}
          EARTHDATA_PASS: ${{ secrets.EARTHDATA_PASS }}
        run: |
          echo "machine urs.earthdata.nasa.gov login $EARTHDATA_USER password $EARTHDATA_PASS" > tests/.netrc
          chmod 0600 tests/.netrc

      - name: Make tests dir writable for jovyan (uid 1000)
        run: |
          sudo chown -R 1000:1000 tests
          sudo chmod -R u+rwX tests

      - name: Run Python xarray test notebook
        run: |
          echo "Running test notebook..."
          docker run --rm \
            -v "$PWD/tests:/tests" \
            ${{ needs.build.outputs.image_name }}:${{ needs.build.outputs.image_tag }} \
            bash -c "set -e && cp /tests/.netrc ~/.netrc && chmod 0600 ~/.netrc && jupyter nbconvert --to notebook --execute /tests/test-python-xarray.ipynb --output /tests/test-python-xarray-output.ipynb"
          echo "✓ Notebook executed successfully"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: tests/test-python-xarray-output.ipynb
          if-no-files-found: warn

  test-packages:
    runs-on: ubuntu-latest
    needs: build
    # Only run if tests are not skipped
    if: ${{ needs.build.outputs.skip_tests == 'false' }}
    outputs:
      validation_status: ${{ steps.pr_body.outputs.status }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: |
          docker load < /tmp/docker-image.tar.gz

      - name: Extract py-rocket-base environment.yaml
        run: |
          docker run --rm --entrypoint cat \
            ${{ needs.build.outputs.image_name }}:${{ needs.build.outputs.image_tag }} \
            /srv/repo/environment.yml > base-environment.yaml
          
          echo "Base environment.yaml extracted to base-environment.yaml"
          head -20 base-environment.yaml

      - name: Extract Python packages with pinned versions
        run: |
          docker run --rm ${{ needs.build.outputs.image_name }}:${{ needs.build.outputs.image_tag }} \
            bash -c 'conda list -n notebook --export' > reproducibility/packages-python-pinned.yaml

          echo "Python packages extracted to reproducibility/packages-python-pinned.yaml"
          head -20 reproducibility/packages-python-pinned.yaml

      - name: Set up Python for validation
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Filter and validate Python packages
        run: |
          python .github/scripts/filter_and_validate_packages.py
          echo "Validation complete. Check reproducibility/build.log for results."
          cat reproducibility/build.log

      - name: Extract R packages with pinned versions
        run: |
          docker run --rm \
            -v "$PWD:/repo" \
            ${{ needs.build.outputs.image_name }}:${{ needs.build.outputs.image_tag }} \
            Rscript /repo/.github/scripts/extract_pins_r.R /usr/local/lib/R/site-library \
            > reproducibility/packages-r-pinned.R

          echo "R packages extracted to reproducibility/packages-r-pinned.R"
          head -30 reproducibility/packages-r-pinned.R

      - name: Validate R packages
        run: |
          # Extract rocker scripts from the container to temporary files
          docker run --rm ${{ needs.build.outputs.image_name }}:${{ needs.build.outputs.image_tag }} cat /rocker_scripts/install_geospatial.sh > /tmp/install_geospatial.sh
          docker run --rm ${{ needs.build.outputs.image_name }}:${{ needs.build.outputs.image_tag }} cat /rocker_scripts/install_tidyverse.sh > /tmp/install_tidyverse.sh

          # Run validation script
          python .github/scripts/validate_r_packages.py

          echo "R package validation complete. Check reproducibility/build.log for results."
          cat reproducibility/build.log

      - name: Set validation status
        id: pr_body
        run: |
          # Count SUCCESS statuses in reproducibility/build.log (should be 2: one for Python, one for R)
          success_count=$(grep -c "STATUS: SUCCESS" reproducibility/build.log || true)
          
          if [ "$success_count" -eq 2 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: |
            reproducibility/packages-python-pinned.yaml
            reproducibility/packages-r-pinned.R
            reproducibility/build.log

  push:
    runs-on: ubuntu-latest
    needs: [build, test-python, test-packages]
    # Run if tests are skipped OR if both test jobs succeeded
    if: |
      always() && 
      (needs.build.outputs.skip_tests == 'true' || 
       (needs.test-python.result == 'success' && needs.test-packages.result == 'success'))
    outputs:
      image_pushed: ${{ steps.push_status.outputs.pushed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: |
          docker load < /tmp/docker-image.tar.gz

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract VERSION from Dockerfile
        id: get_version
        run: |
          if grep -q "LABEL org.opencontainers.image.version=" Dockerfile; then
            version=$(grep "LABEL org.opencontainers.image.version=" Dockerfile | cut -d '=' -f 2 | tr -d ' ')
          elif grep -q "LABEL VERSION=" Dockerfile; then
            version=$(grep "LABEL VERSION=" Dockerfile | cut -d '=' -f 2 | tr -d ' ')
          else
            version=""
          fi
          echo "version=${version}" >> $GITHUB_ENV

      - name: Push the Docker image
        id: push_status
        run: |
          docker push ${{ needs.build.outputs.image_name }}:${{ needs.build.outputs.image_tag }}
          docker push ${{ needs.build.outputs.image_name }}:latest
          
          # Push the version tag if it exists
          if [ -n "${{ env.version }}" ]; then
            docker tag ${{ needs.build.outputs.image_name }}:${{ needs.build.outputs.image_tag }} ${{ needs.build.outputs.image_name }}:${{ env.version }}
            docker push ${{ needs.build.outputs.image_name }}:${{ env.version }}
          fi
          
          echo "pushed=true" >> $GITHUB_OUTPUT
          echo "✓ Docker image pushed successfully"

  create-release-pr:
    runs-on: ubuntu-latest
    needs: [build, test-packages, push]
    # Only run if push succeeded and tests were not skipped
    if: |
      always() && 
      needs.push.outputs.image_pushed == 'true' &&
      needs.build.outputs.skip_tests == 'false'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download validation results
        uses: actions/download-artifact@v4
        with:
          name: validation-results
          path: reproducibility

      - name: Set PR body based on validation results
        id: pr_body
        run: |
          # Count SUCCESS statuses in reproducibility/build.log (should be 2: one for Python, one for R)
          success_count=$(grep -c "STATUS: SUCCESS" reproducibility/build.log || true)
          
          # Get test status
          test_status="✅ All tests passed"
          if [ "${{ needs.test-packages.outputs.validation_status }}" != "success" ]; then
            test_status="⚠️ Package validation had warnings (see build.log)"
          fi
          
          if [ "$success_count" -eq 2 ]; then
            cat > reproducibility/pr_body.txt << EOF
          ## Package Validation: ✅ SUCCESS
          
          **Docker Image:** \`${{ needs.build.outputs.image_name }}:${{ needs.build.outputs.image_tag }}\`
          
          **Test Status:** ${test_status}
          
          All Python packages from env-*.yml files and all R packages from install.R,
          install_geospatial.sh, and install_tidyverse.sh are present in the container image.
          
          ### Changes
          - **reproducibility/packages-python-pinned.yaml**: Updated with packages from env files only (not all 900+ conda packages)
          - **reproducibility/packages-r-pinned.R**: Updated with latest R package versions from site-library
          - **reproducibility/build.log**: Validation report for both Python and R packages
          
          Auto-generated from latest container image build.
          EOF
          else
            cat > reproducibility/pr_body.txt << EOF
          ## Package Validation: ⚠️ FAILED
          
          **Docker Image:** \`${{ needs.build.outputs.image_name }}:${{ needs.build.outputs.image_tag }}\`
          
          **Test Status:** ${test_status}
          
          Some packages were NOT found in the container image. Check reproducibility/build.log for details.
          
          ### Changes
          - **reproducibility/packages-python-pinned.yaml**: Updated with subset of packages that were successfully installed
          - **reproducibility/packages-r-pinned.R**: Updated with latest R package versions
          - **reproducibility/build.log**: Detailed report of missing packages (both Python and R)
          
          **Action Required:** Review reproducibility/build.log for missing packages and investigate installation issues.
          
          Auto-generated from latest container image build.
          EOF
          fi

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add reproducibility/packages-python-pinned.yaml reproducibility/packages-r-pinned.R reproducibility/build.log

          if ! git diff --staged --quiet; then
            git commit -m "Update pinned package versions from container image"
          else
            echo "No changes to commit"
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ci/update-pins-${{ needs.build.outputs.image_tag }}
          delete-branch: true
          title: "Update pinned package versions - Build ${{ needs.build.outputs.image_tag }}"
          body-path: reproducibility/pr_body.txt
          assignees: eeholmes
          reviewers: eeholmes
          commit-message: "Update pinned package versions from container image ${{ needs.build.outputs.image_tag }}"
